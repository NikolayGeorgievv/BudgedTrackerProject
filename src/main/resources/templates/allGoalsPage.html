<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <!--    FONTAWESOME KIT-->
    <script src="https://kit.fontawesome.com/1a33788db9.js" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>All expenses page</title>
</head>
<body style="height: 100vh; margin: 0; background-image: url('/images/main-table-bg-img.jpg');">

<div>
    <nav th:replace="~{fragments/navbar-logged}"></nav>
</div>

<div class="d-flex">
    <div>
        <div th:replace="~{fragments/sideBar}" style="margin-right: 0"></div>
    </div>

    <!--    main div for table-->
    <div class="flex-grow-1" style="border-radius: 10px">
        <div class="d-flex justify-content-between">
            <h3 style="margin: 10px">My Goals</h3>
            <div style="padding: 10px">
                <button th:replace="~{fragments/completedGoalsFragment}"></button>
            </div>
        </div>
        <div class="d-flex" style="border-top: 1px solid #2c396a;border-bottom: 1px solid #2c396a">
            <!--            TOP BAR-->
        </div>

        <div class="flex-grow-1">
            <!--        div for table-->
            <div class="d-flex">
                <table class="table table-borderless table-hover" id="goalsTable"
                       th:action="@{/allGoalsPage}"
                       th:method="get"
                       th:object="${allUncompletedGoalsInfoDTO}">

                    <thead>
                    <tr>
                        <th scope="col" width="10%">Goal</th>
                        <th scope="col" width="20%">Target</th>
                        <th scope="col" width="20%">Progress</th>
                        <th scope="col" width="25%">Description</th>
                        <th scope="col" width="10%">Account</th>
                        <th scope="col" width="14%"></th>
                        <th scope="col" width="1%"></th>

                    </tr>
                    </thead>

                    <tbody>

                    <tr class="border-top border-bottom" th:each="g : ${allUncompletedGoalsInfoDTO.getAllGoals()}"
                        th:id="'goalRow-' + ${g.getId()}"
                    >

                        <td
                                th:text="${g.getName()}"
                                th:value="${g.getName()}"
                                style="padding-left: 15px; font-weight: 550;">
                        </td>
                        <td
                                th:text="'$' +  ${g.getCurrentAmount()} + ' out of $' + ${g.getAmountToBeSaved()}"
                                th:value="'$' +  ${g.getCurrentAmount()} + ' out of $' + ${g.getAmountToBeSaved()}"
                                style="border: none; font-weight: bold; font-style: italic;">

                        </td>
                        <td>
                            <div class="goal-progress">
                                <div class="progress-bar" th:id="'progressBar' + ${g.getId()}"
                                     style="width: 50%;"></div>
                            </div>
                        </td>
                        <td
                                th:text="${g.getDescription()}"
                                th:value="${g.getDescription()}"
                                style="font-weight: 550;">

                        </td>
                        <td
                                th:text="${g.getAccountToUse()}"
                                th:value="${g.getAccountToUse()}"
                                style="font-weight: 550;">

                        </td>

                        <td>
                            <div class="d-flex flex-row">
                                <div style="margin-right: 5px">
                                    <form
                                            th:action="@{/editGoal}"
                                            th:method="post">
                                        <button
                                                type="button" class="btn btn-outline-info btn-sm px-3 me-sm-1 fw-bold"
                                                th:id="'updateGoalButton-' + ${g.getId()}" name="goalId"
                                                title="Edit goal" th:value="${g.getId()}"
                                                data-bs-toggle="modal" data-bs-target="#editGoalModal"
                                                th:onclick="getGoalId(/*[[${g.getId()}]]*/)"
                                        >
                                            <i class="fa-solid fa-pen-to-square"></i></button>

                                    </form>
                                </div>
                                <div>
                                    <form
                                            th:action="@{/deleteGoal}"
                                            th:method="get">
                                        <a class="btn btn-outline-info btn-sm px-3 me-sm-3 fw-bold" title="Delete goal"
                                           th:href="@{/deleteGoal/{goalId}(goalId = ${g.getId()})}">
                                            <i class="fa-solid fa-trash-can"></i></a>

                                    </form>
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type="hidden" th:value="${g.getBarProgress()}" th:id="'goalBarId' + ${g.getId()}">
                        </td>
                        <script th:inline="javascript">
                            /*<![CDATA[*/
                            for (let i = 0; i < goalsTable.rows.length; i++) {
                                let progressBarId = 'progressBar' + /*[[${g.getId()}]]*/ null;

                                let progressBar = document.getElementById(progressBarId);
                                progressBarPercentage = /*[[${g.getBarProgress()}]]*/ 2222;

                                if (progressBarPercentage <= 25) {
                                    if (progressBarPercentage === 0) {
                                        progressBarPercentage = 1;
                                    }
                                    progressBar.style.backgroundColor = "#FF2400";
                                } else if (progressBarPercentage > 25 && progressBarPercentage <= 60) {
                                    progressBar.style.backgroundColor = "#ecc400";
                                } else if (progressBarPercentage > 60) {
                                    progressBar.style.backgroundColor = "#4caf50";
                                    if (progressBarPercentage > 100 || progressBarPercentage === 100) {
                                        progressBarPercentage = 100;
                                        progressBar.style.backgroundColor = "#4caf50";
                                    }
                                }
                                progressBar.style.width = `${progressBarPercentage}%`;
                            }
                            /*]]>*/
                        </script>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editGoalModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" id="goalModalContent">
            <div class="flex-grow-1">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Edit Goal</h5>
                </div>
                <div class="modal-body">
                    <form th:action="@{/editGoal}"
                          th:method="post"
                          th:object="${editGoalDTO}">
                        <div class="d-flex flex-column justify-content-between">
                            <div class="d-flex flex-column justify-content-between">
                                <label for="newGoalName">New Name:</label>
                                <input type="text" id="newGoalName" name="newGoalName">
                            </div>
                            <div class="d-flex flex-column justify-content-between">
                                <label for="addedAmount">Add Funds:</label>
                                <input type="number" min="0" id="addedAmount" name="addedAmount">
                            </div>
                            <div class="d-flex justify-content-between" style="margin: 5px">
                                <div class="d-flex flex-column" style="width: 100%">
                                    <label id="accountToUseLabel">From account</label>
                                    <!--  TODO: DEFAULT SHOULD BE CURRENT USED ACCOUNT-->
                                    <select name="accountToUse">
                                        <option
                                                th:each="a : ${allAccountsInfoDTO.getAllAccounts()}"
                                                th:text="${a.getName()}"
                                                th:value="${a.getName()}"
                                        >
                                        </option>
                                    </select>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault"
                                               name="isNewPrimary">
                                        <label class="form-check-label" for="flexSwitchCheckDefault">Make this account
                                            primary for this goal.</label>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-column justify-content-between" style="margin: 5px">
                                <label>Description</label>
                                <textarea placeholder="Got a new description?" name="description" id="description"
                                          style="width: 100%; height: 80px"></textarea>
                            </div>
                            <br>
                            <div class="d-flex flex-column justify-content-between">
                                <button type="submit" class="button" id="submitButton">Update</button>
                            </div>
                            <input type="hidden" id="goalId1" name="id"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    .table {
        --bs-table-bg: transparent;
    }

    .goal-progress {
        width: 100%;
        height: 15px;
        background-color: #f0f0f0;
        border-radius: 10px;
    }

    .progress-bar {
        height: 100%;
        background-color: #4caf50;
        border-radius: 10px;
    }

    #goalModalContent {
        border: 3px solid #f1f1f1;
        background-color: #2c396a;
    }

    #editModalLabel {
        color: white;
    }
</style>

<script th:inline="javascript">
    let goalsTable = document.getElementById("goalsTable");
    let progressBarPercentage = 0;

    function getGoalId(goalId) {
        document.getElementById("goalId1").value = goalId;
        console.log(goalId)
    }


</script>
</body>
</html>